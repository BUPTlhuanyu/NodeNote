## node everywhere

#### ğŸ’¡ğŸ’¡ğŸ’¡ ä¸€äº›æ€è€ƒï¼š
- [ ] ä¸­é—´ä»¶ç³»ç»Ÿå¸¦æ¥çš„é—®é¢˜ï¼Œä¸­é—´ä»¶å¯ä»¥éšæ„ç»™ctxå®šä¹‰å®ä¾‹æ–¹æ³•ä»¥åŠå±æ€§ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸­é—´ä»¶ä¹‹é—´çš„è¦†ç›–çš„é—®é¢˜ï¼Œå¾ˆéš¾æ£€æŸ¥ä¸é”™è¯¯ã€‚

> å…¶å®æœ¬æ¥æ˜¯æƒ³ç»•å¼€nodejså­¦ä¸€ä¸‹javaåšåç«¯webå¼€å‘çš„ï¼Œä½†æ˜¯æ— è®ºå¯¹äºå‰ç«¯è¿˜æ˜¯å‰åç«¯åŒæ„ï¼ˆssrå¹¶ä¸æ˜¯å¿…å¤‡çš„ï¼Œå¯¹äºé‚£äº›å¯¹é¦–å±åŠ è½½é€Ÿåº¦æœ‰ä¸¥æ ¼è¦æ±‚ï¼ŒæŠ‘æˆ–æ˜¯å¯¹äº§å“æµé‡æ¥è‡ªæœç´¢çš„SPAæ¥è¯´ssræ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼‰
è€Œè¨€ç›®å‰æ‰“åŒ…å·¥å…·webpackæ˜¯å¿…ä¸å¯å°‘çš„ã€‚nodeçš„å­¦ä¹ æ˜¯ç†è§£è¿™äº›æ‰“åŒ…å·¥å…·å·¥ä½œåŸç†çš„å¿…ç»ä¹‹è·¯ã€‚å› æ­¤æ‰“ç®—ç ”ç©¶ä¸€ä¸‹nodeä»¥åŠè½»é‡çº§webæ¡†æ¶koaçš„å®ç°åŸç†ã€‚
è¿™é‡Œå°±å…ˆç›´æ¥è·Ÿç€å‰äººè„šæ­¥æ¥å­¦ä¹ å§ï¼æ¯•ç«Ÿä¸€äººçš„è§è§£æ˜¯ä¸å¤Ÿå…¨é¢çš„ï¼

#### å¯¹nodeçš„ä¸€äº›ç†è§£
        - éé˜»å¡I/Oå¯†é›†å‹,äº‹ä»¶é©±åŠ¨ï¼Œå•çº¿ç¨‹
            å¯¹äºcpuèŠ¯ç‰‡è€Œè¨€ï¼Œæœ‰vccï¼Œgroundï¼ŒI/Oç­‰ç­‰å¼•è„šï¼Œè¿™äº›I/Oä¸Šå¯ä»¥è¿æ¥ä¸Šè®¸å¤šå¤–è®¾æ¯”å¦‚é¼ æ ‡é”®ç›˜ç­‰ç­‰åŠŸèƒ½æ¨¡å—ï¼ŒCPUåªä¸“æ³¨äºæ§åˆ¶å’Œè¿ç®—ï¼Œnodeæ˜¯å•çº¿ç¨‹çš„æ˜¯æŒ‡
            nodeçš„jsæ‰§è¡Œæ ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨è¿™ä¸ªçº¿ç¨‹è¿è¡Œçš„æ—¶å€™é‡åˆ°I/Oæ“ä½œï¼Œæ¯”å¦‚è¯»å–æ–‡ä»¶ï¼Œä¼šå°†è¿™ä¸ªæ“ä½œä¸¢ç»™æ“ä½œç³»ç»Ÿè¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œnodeä¸­jsæ‰§è¡Œçº¿ç¨‹ç»§ç»­æ‰§è¡Œåé¢
            çš„ä»£ç ã€‚å½“æ–‡ä»¶è¯»å–å®Œæˆä¹‹åä¼šå‡ºå‘ä¸€ä¸ªäº‹ä»¶è°ƒç”¨å¯¹åº”çš„å›è°ƒå‡½æ•°ï¼Œå½“ç„¶è¿™ä¸ªå›è°ƒæœ‰å¯èƒ½è¢«é˜»å¡ã€‚ç”±äºnodeçš„å•çº¿ç¨‹ç‰¹ç‚¹ï¼Œå› æ­¤ä¸é€‚åˆcpuå¯†é›†å‹çš„é¡¹ç›®ã€‚ä¸€èˆ¬node
            ç”¨äºåšä¸­é—´ä»£ç†ï¼Œä½œä¸ºé™æ€èµ„æºæœåŠ¡å™¨ï¼Œå¯¹äºé‚£äº›éœ€è¦é€šè¿‡å¤æ‚è®¡ç®—æ‰èƒ½å¾—åˆ°æ•°æ®ï¼Œä¸€èˆ¬ä¼šè½¬å‘ç»™APIæœåŠ¡å™¨è¿›è¡Œå¤„ç†ã€‚å› ä¸ºå¦‚æœnodeå¤„ç†è¿™äº›è¯·æ±‚ï¼Œé‚£ä¹ˆnodeä¼š
            è¢«è¿™ä¸ªå¤æ‚çš„è®¡ç®—ç»™é˜»å¡ï¼Œå…¶ä»–è¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¼šéœ€è¦ç­‰å¾…å¾ˆé•¿æ—¶é—´ã€‚

> [Koa2å®˜ç½‘](https://koa.bootcss.com/) â€”â€”> [githubåœ°å€](https://github.com/koajs/koa)

> [Koa.js è®¾è®¡æ¨¡å¼-å­¦ä¹ ç¬”è®°](https://chenshenhai.github.io/koajs-design-note/) â€”â€”> [githubåœ°å€](https://github.com/chenshenhai/koajs-design-note)

åœ¨ç¼–å†™çº§è”çš„ä¸­é—´ä»¶çš„æ—¶å€™ï¼Œæ¯”å¦‚ï¼š

    const Koa = require('koa');
    const app = new Koa();

    // logger

    app.use(async (ctx, next) => {
      await next();
      const rt = ctx.response.get('X-Response-Time');
      console.log(`${ctx.method} ${ctx.url} - ${rt}`);
    });

    // x-response-time

    app.use(async (ctx, next) => {
      const start = Date.now();
      await next();
      const ms = Date.now() - start;
      ctx.set('X-Response-Time', `${ms}ms`);
    });

    // response

    app.use(async ctx => {
      ctx.body = 'Hello World';
    });

    app.listen(3000);

è¿™é‡Œä¸­é—´ä»¶çº§è”çš„æ–¹å¼å¯¹ctxè¿›è¡Œé€æ­¥å¤„ç†ï¼Œæ ¹æ®compose.jså¯çŸ¥ä¼ å…¥ä¸­é—´ä»¶çš„nextå…¶å®å°±æ˜¯ï¼š

    dispatch.bind(null, i + 1)

å…·ä½“å·¥ä½œåŸç†ï¼š

1ã€åˆ›å»ºä¸€ä¸ªkoaå¯¹è±¡ï¼Œç„¶åè°ƒç”¨use(fn)å°†fn pushåˆ°è¯¥koaå¯¹è±¡çš„ä¸­é—´ä»¶æ•°ç»„ä¸­ï¼Œ

2ã€æ¥ç€è°ƒç”¨listenåˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å®¹å™¨ï¼Œç„¶åè°ƒç”¨this.callback()ï¼Œç„¶åç›‘å¬æŒ‡å®šç«¯å£

3ã€this.callback()é¦–å…ˆä¼šè°ƒç”¨composeå¯¹ä¸­é—´ä»¶æ•°ç»„è¿›è¡Œå¤„ç†ï¼Œè¿”å›ä¸€ä¸ªæ´‹è‘±æ¨¡å‹çš„å…¥å£å‡½æ•°ã€‚ç„¶åè¿”å›ä¸€ä¸ªhandleRequest

4ã€handleRequestå‡½æ•°ä¼šåœ¨ç›‘å¬åˆ°ç«¯å£æœ‰è¯·æ±‚çš„æ—¶å€™è°ƒç”¨ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨æ´‹è‘±æ¨¡å‹çš„å…¥å£å‡½æ•°ã€‚

5ã€handleRequestå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°req, resï¼›è¯¥å‡½æ•°æ‰§è¡Œçš„æ—¶å€™é¦–å…ˆä¼šæ ¹æ®ä¼ å…¥çš„req, resåˆ›å»ºä¸€ä¸ªctxï¼›ç„¶åè°ƒç”¨koaå¯¹è±¡çš„handleRequestå‡½æ•°ï¼Œå°†ç»“æœè¿”å›ã€‚

6ã€koaå¯¹è±¡çš„handleRequestå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°(ctx, fn)ï¼Œctxå°±æ˜¯æ ¹æ®req, resåˆ›å»ºçš„ctxï¼Œfnå°±æ˜¯è°ƒç”¨composeè¿”å›çš„æ´‹è‘±æ¨¡å‹å…¥å£å‡½æ•°ã€‚
   koaå¯¹è±¡çš„handleRequestå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨fn(ctx)

åœ¨ä¸­é—´ä»¶éœ€è¦çº§è”çš„æ—¶å€™ï¼Œéœ€è¦ç»™ä¸­é—´ä»¶ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°next


ToDo

- [ ] AOPé¢å‘åˆ‡é¢ç¼–ç¨‹:é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰æ˜¯ä¸€ç§éä¾µå…¥å¼æ‰©å……å¯¹è±¡ã€æ–¹æ³•å’Œå‡½æ•°è¡Œä¸ºçš„æŠ€æœ¯ã€‚é€šè¿‡ AOP å¯ä»¥ä»â€œå¤–éƒ¨â€å»å¢åŠ ä¸€äº›è¡Œä¸ºï¼Œè¿›è€Œåˆå¹¶æ—¢æœ‰è¡Œä¸ºæˆ–ä¿®æ”¹æ—¢æœ‰è¡Œä¸ºã€‚
- [ ] IOC???
- [ ] å†…å­˜ç®¡ç†process.memoryUsage

> [Koa2è¿›é˜¶å­¦ä¹ ç¬”è®°](https://chenshenhai.github.io/koa2-note/) â€”â€”> [githubåœ°å€](https://github.com/chenshenhai/koa2-note)